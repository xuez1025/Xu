-- 防止重複開啟
if game.CoreGui:FindFirstChild("UniversalCoordinatesGui") then
    game.CoreGui.UniversalCoordinatesGui:Destroy()
end

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
if not LocalPlayer then return end

-- 建立 ScreenGui（放 CoreGui 才能全遊戲使用）
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "UniversalCoordinatesGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = game.CoreGui

-- 主框架
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 250, 0, 120)
frame.Position = UDim2.new(0.4, 0, 0.8, 0)
frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
frame.BorderSizePixel = 0
frame.Active = true
frame.Parent = screenGui

-- 圓角
local corner = Instance.new("UICorner", frame)
corner.CornerRadius = UDim.new(0, 10)

-- 座標文字
local label = Instance.new("TextLabel")
label.Size = UDim2.new(1, -10, 0.6, 0)
label.Position = UDim2.new(0, 5, 0, 5)
label.BackgroundTransparency = 1
label.TextColor3 = Color3.new(1,1,1)
label.TextScaled = true
label.Font = Enum.Font.SourceSansBold
label.Text = "Loading..."
label.Parent = frame

-- Copy 按鈕
local copyButton = Instance.new("TextButton")
copyButton.Size = UDim2.new(0.6, 0, 0.3, 0)
copyButton.Position = UDim2.new(0.2, 0, 0.65, 0)
copyButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
copyButton.TextColor3 = Color3.new(1,1,1)
copyButton.TextScaled = true
copyButton.Font = Enum.Font.SourceSansBold
copyButton.Text = "Copy"
copyButton.Parent = frame

Instance.new("UICorner", copyButton)

-- 關閉按鈕
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 24, 0, 24)
closeButton.Position = UDim2.new(1, -28, 0, 4)
closeButton.BackgroundColor3 = Color3.fromRGB(150,0,0)
closeButton.TextColor3 = Color3.new(1,1,1)
closeButton.Text = "X"
closeButton.TextScaled = true
closeButton.Parent = frame

Instance.new("UICorner", closeButton)

closeButton.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)

-- 拖曳功能（新版安全拖曳）
local dragging = false
local dragInput, dragStart, startPos

frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

-- 更新座標（支援重生）
local function getHRP()
    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    return character:WaitForChild("HumanoidRootPart", 5)
end

RunService.RenderStepped:Connect(function()
    local hrp = getHRP()
    if hrp then
        local pos = hrp.Position
        label.Text = string.format("(%.0f, %.0f, %.0f)", pos.X, pos.Y, pos.Z)
    end
end)

-- Copy 功能
copyButton.MouseButton1Click:Connect(function()
    local hrp = getHRP()
    if hrp then
        local pos = hrp.Position
        local text = string.format("(%.0f, %.0f, %.0f)", pos.X, pos.Y, pos.Z)
        if setclipboard then
            setclipboard(text)
        end
    end
end)
