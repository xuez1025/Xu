local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ================= UI =================
local screenGui = Instance.new("ScreenGui", playerGui)

local frame = Instance.new("Frame", screenGui)
frame.Size = UDim2.new(0, 280, 0, 320)
frame.Position = UDim2.new(0.5, -140, 0.5, -160)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.ClipsDescendants = true
frame.AnchorPoint = Vector2.new(0.5, 0.5)
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 15)

-- 標題
local titleLabel = Instance.new("TextLabel", frame)
titleLabel.Size = UDim2.new(1, -50, 0, 30)
titleLabel.Position = UDim2.new(0, 10, 0, 10)
titleLabel.Text = "Xu-Auto Fly & Pull NPC"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.BackgroundTransparency = 1
titleLabel.TextScaled = true
titleLabel.Font = Enum.Font.SourceSansBold
titleLabel.Active = true

-- 關閉按鈕
local closeButton = Instance.new("TextButton", frame)
closeButton.Size = UDim2.new(0, 30, 0, 30)
closeButton.Position = UDim2.new(1, -40, 0, 10)
closeButton.Text = "X"
closeButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
closeButton.TextColor3 = Color3.fromRGB(255,255,255)
closeButton.TextScaled = true
closeButton.Font = Enum.Font.SourceSansBold
Instance.new("UICorner", closeButton).CornerRadius = UDim.new(0, 8)

-- 飛行按鈕
local toggleButton = Instance.new("TextButton", frame)
toggleButton.Size = UDim2.new(0, 180, 0, 40)
toggleButton.Position = UDim2.new(0.5, -90, 0, 60)
toggleButton.Text = "飛行: OFF"
toggleButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.TextScaled = true
toggleButton.Font = Enum.Font.SourceSansBold
Instance.new("UICorner", toggleButton).CornerRadius = UDim.new(0, 8)

-- 提示文字
local infoLabel = Instance.new("TextLabel", frame)
infoLabel.Size = UDim2.new(0, 240, 0, 25)
infoLabel.Position = UDim2.new(0.5, -120, 0, 110)
infoLabel.Text = ""
infoLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
infoLabel.BackgroundTransparency = 1
infoLabel.TextScaled = true
infoLabel.Font = Enum.Font.SourceSansBold

-- 吸怪範圍滑桿
local pullLabel = Instance.new("TextLabel", frame)
pullLabel.Size = UDim2.new(0, 240, 0, 25)
pullLabel.Position = UDim2.new(0.5, -120, 0, 140)
pullLabel.Text = "吸怪範圍: 100"
pullLabel.TextColor3 = Color3.fromRGB(255,255,255)
pullLabel.BackgroundTransparency = 1
pullLabel.TextScaled = true
pullLabel.Font = Enum.Font.SourceSans

local sliderPull = Instance.new("Frame", frame)
sliderPull.Size = UDim2.new(0, 240, 0, 20)
sliderPull.Position = UDim2.new(0.5, -120, 0, 170)
sliderPull.BackgroundColor3 = Color3.fromRGB(80,80,80)
Instance.new("UICorner", sliderPull).CornerRadius = UDim.new(0, 10)

local handlePull = Instance.new("Frame", sliderPull)
handlePull.Size = UDim2.new(0, 20, 1, 0)
handlePull.Position = UDim2.new(100/300, -10, 0, 0) -- 初始 100 對應位置
handlePull.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
Instance.new("UICorner", handlePull).CornerRadius = UDim.new(0, 10)

-- TP 範圍滑桿
local rangeLabel = Instance.new("TextLabel", frame)
rangeLabel.Size = UDim2.new(0, 240, 0, 25)
rangeLabel.Position = UDim2.new(0.5, -120, 0, 200)
rangeLabel.Text = "TP 範圍: 500"
rangeLabel.TextColor3 = Color3.fromRGB(255,255,255)
rangeLabel.BackgroundTransparency = 1
rangeLabel.TextScaled = true
rangeLabel.Font = Enum.Font.SourceSans

local sliderRange = Instance.new("Frame", frame)
sliderRange.Size = UDim2.new(0, 240, 0, 20)
sliderRange.Position = UDim2.new(0.5, -120, 0, 230)
sliderRange.BackgroundColor3 = Color3.fromRGB(80,80,80)
Instance.new("UICorner", sliderRange).CornerRadius = UDim.new(0, 10)

local handleRange = Instance.new("Frame", sliderRange)
handleRange.Size = UDim2.new(0, 20, 1, 0)
handleRange.Position = UDim2.new(500/2000, -10, 0, 0)
handleRange.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
Instance.new("UICorner", handleRange).CornerRadius = UDim.new(0, 10)

-- ================= 狀態變數 =================
local isFlying = false
local flyConnection
local pullRange = 100
local tpRange = 500
local baseSpeed = 0.1
local draggingUI = false
local dragOffset = Vector2.new(0,0)
local draggingSlider = false
local MAX_PULL_FROM_SPAWN = 50 -- 最大吸怪距離從出生點

-- ================= 飛行與吸怪核心 =================
local function stopFlying()
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    isFlying = false
    toggleButton.Text = "飛行: OFF"
    toggleButton.BackgroundColor3 = Color3.fromRGB(255,0,0)
end

local function toggleFly()
    isFlying = not isFlying
    if isFlying then
        toggleButton.Text = "飛行: ON"
        toggleButton.BackgroundColor3 = Color3.fromRGB(0,255,0)

        flyConnection = RunService.Heartbeat:Connect(function()
            local character = player.Character or player.CharacterAdded:Wait()
            local hrp = character:WaitForChild("HumanoidRootPart")
            local enemiesFolder = workspace:FindFirstChild("Enemies")
            local nearest = nil
            local minDist = math.huge

            if enemiesFolder then
                -- 找最近 NPC (TP用)
                for _, npc in pairs(enemiesFolder:GetChildren()) do
                    if npc:FindFirstChild("Humanoid") and npc.Humanoid.Health > 0 then
                        local npcPos = npc:FindFirstChild("Head") and npc.Head.Position or npc.HumanoidRootPart.Position
                        local dist = (npcPos - hrp.Position).Magnitude
                        if dist < minDist and dist <= tpRange then
                            minDist = dist
                            nearest = npc
                        end
                    end
                end

                -- 吸怪 (限制吸附範圍 & 離出生點距離)
                for _, npc in pairs(enemiesFolder:GetChildren()) do
                    if npc:FindFirstChild("Humanoid") and npc.Humanoid.Health > 0 then
                        local npcPos = npc:FindFirstChild("Head") and npc.Head.Position or npc.HumanoidRootPart.Position
                        local dist = (npcPos - hrp.Position).Magnitude

                        -- 取得出生點，若無則用初始位置
                        local spawnPos = npc:FindFirstChild("SpawnPosition") and npc.SpawnPosition.Value or npc.PrimaryPart.Position
                        local distFromSpawn = (npc.PrimaryPart.Position - spawnPos).Magnitude

                        if dist <= pullRange and distFromSpawn <= MAX_PULL_FROM_SPAWN then
                            local pullTarget = hrp.Position - Vector3.new(0, 25, 0)
                            npc:SetPrimaryPartCFrame(CFrame.new(npc.PrimaryPart.Position:Lerp(pullTarget, 0.5)))
                        end
                    end
                end
            end

            -- 飛行 TP 到最近 NPC
            if nearest then
                local targetPos = nearest:FindFirstChild("Head") and nearest.Head.Position or nearest.HumanoidRootPart.Position
                targetPos = targetPos + Vector3.new(0,25,0)
                hrp.CFrame = CFrame.new(hrp.Position:Lerp(targetPos, baseSpeed))
                infoLabel.Text = ""
            else
                infoLabel.Text = "範圍內無 NPC！"
            end
        end)

    else
        stopFlying()
        infoLabel.Text = ""
    end
end

toggleButton.MouseButton1Click:Connect(toggleFly)

-- ================= 滑桿控制 =================
local function updateSlider(slider, handle, maxValue, label, isPull)
    local dragging = false
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            draggingSlider = true
        end
    end)
    handle.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
            draggingSlider = false
        end
    end)
    local function update(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local mouseX = input.Position.X
            local basePos = slider.AbsolutePosition.X
            local baseSize = slider.AbsoluteSize.X
            local relativePos = math.clamp(mouseX - basePos, 0, baseSize)
            handle.Position = UDim2.new(0, relativePos - handle.AbsoluteSize.X/2, 0, 0)
            if isPull then
                pullRange = math.floor((relativePos / baseSize) * maxValue)
                label.Text = "吸怪範圍: "..pullRange
            else
                tpRange = math.floor((relativePos / baseSize) * maxValue)
                label.Text = "TP 範圍: "..tpRange
            end
        end
    end
    handle.InputChanged:Connect(update)
    slider.InputChanged:Connect(update)
end

updateSlider(sliderPull, handlePull, 300, pullLabel, true) -- 上限 300
updateSlider(sliderRange, handleRange, 2000, rangeLabel, false)

-- ================= UI 拖動 =================
titleLabel.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 and not draggingSlider then
        draggingUI = true
        local mousePos = UserInputService:GetMouseLocation()
        dragOffset = Vector2.new(mousePos.X - frame.AbsolutePosition.X, mousePos.Y - frame.AbsolutePosition.Y)
    end
end)
titleLabel.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingUI = false
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if draggingUI and input.UserInputType == Enum.UserInputType.MouseMovement then
        local mousePos = UserInputService:GetMouseLocation()
        frame.Position = UDim2.new(0, mousePos.X - dragOffset.X, 0, mousePos.Y - dragOffset.Y)
    end
end)

-- ================= 關閉 UI =================
closeButton.MouseButton1Click:Connect(function()
    stopFlying()
    draggingSlider = false
    screenGui:Destroy()
end)
