-- ================= Services =================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

-- ================= State =================
local FlyEnabled = false
local TargetPlayer = nil
local NoclipEnabled = false
local FlySpeed = 350 -- 飛行速度，可自行調整

-- ================= Fly Functions =================
function EnableFly()
    local char = LocalPlayer.Character
    if not char then return end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if hum then
        hum.PlatformStand = true
    end
end

function DisableFly()
    local char = LocalPlayer.Character
    if not char then return end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if hum then
        hum.PlatformStand = false 
    end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if hrp then
        hrp.Velocity = Vector3.zero
    end
end

-- ================= Noclip =================
RunService.Stepped:Connect(function()
    if NoclipEnabled then
        local char = LocalPlayer.Character
        if char then
            for _, part in ipairs(char:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
    end
end)

-- ================= GUI =================
local ScreenGui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
ScreenGui.Name = "FlyGUI"

local Main = Instance.new("Frame", ScreenGui)
Main.Size = UDim2.new(0,260,0,360)
Main.Position = UDim2.new(0,20,0.5,-180)
Main.BackgroundColor3 = Color3.fromRGB(25,25,25)
Main.BorderSizePixel = 0
Instance.new("UICorner", Main)

local Title = Instance.new("TextLabel", Main)
Title.Size = UDim2.new(1,0,0,40)
Title.BackgroundTransparency = 1
Title.Text = "Fly To Player"
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 20

local Toggle = Instance.new("TextButton", Main)
Toggle.Position = UDim2.new(0,10,0,50)
Toggle.Size = UDim2.new(1,-20,0,40)
Toggle.Text = "START FLY"
Toggle.BackgroundColor3 = Color3.fromRGB(0,170,0)
Toggle.TextColor3 = Color3.new(1,1,1)
Toggle.Font = Enum.Font.SourceSansBold
Toggle.TextSize = 18
Instance.new("UICorner", Toggle)

local ListFrame = Instance.new("ScrollingFrame", Main)
ListFrame.Position = UDim2.new(0,10,0,100)
ListFrame.Size = UDim2.new(1,-20,1,-110)
ListFrame.CanvasSize = UDim2.new(0,0,0,0)
ListFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
ListFrame.BorderSizePixel = 0
Instance.new("UICorner", ListFrame)

local UIList = Instance.new("UIListLayout", ListFrame)
UIList.Padding = UDim.new(0,5)

local PlayerButtons = {}

local function RefreshPlayers()
    for _,b in pairs(PlayerButtons) do b:Destroy() end
    PlayerButtons = {}

    for _,plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            local Btn = Instance.new("TextButton")
            Btn.Size = UDim2.new(1,-10,0,35)
            Btn.Text = plr.Name
            Btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
            Btn.TextColor3 = Color3.new(1,1,1)
            Btn.Font = Enum.Font.SourceSans
            Btn.TextSize = 16
            Btn.Parent = ListFrame
            Instance.new("UICorner", Btn)

            Btn.MouseButton1Click:Connect(function()
                TargetPlayer = plr
                for _,v in pairs(PlayerButtons) do
                    v.BackgroundColor3 = Color3.fromRGB(60,60,60)
                end
                Btn.BackgroundColor3 = Color3.fromRGB(0,120,255)
            end)

            table.insert(PlayerButtons, Btn)
        end
    end

    ListFrame.CanvasSize = UDim2.new(0,0,0,UIList.AbsoluteContentSize.Y + 10)
end

Players.PlayerAdded:Connect(RefreshPlayers)
Players.PlayerRemoving:Connect(RefreshPlayers)
RefreshPlayers()

-- ================= Toggle Fly =================
Toggle.MouseButton1Click:Connect(function()
    FlyEnabled = not FlyEnabled

    if FlyEnabled then
        Toggle.Text = "STOP FLY"
        Toggle.BackgroundColor3 = Color3.fromRGB(170,0,0)

        EnableFly()
        NoclipEnabled = true
    else
        Toggle.Text = "START FLY"
        Toggle.BackgroundColor3 = Color3.fromRGB(0,170,0)

        DisableFly()
        NoclipEnabled = false
    end
end)

-- ================= Fly Logic =================
RunService.RenderStepped:Connect(function()
    if FlyEnabled and TargetPlayer then
        local char = LocalPlayer.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        local targetChar = TargetPlayer.Character
        local targetHRP = targetChar and targetChar:FindFirstChild("HumanoidRootPart")
        if not hrp or not targetHRP then return end

        -- 計算飛行方向
        local direction = (targetHRP.Position - hrp.Position)
        if direction.Magnitude > 0 then
            direction = direction.Unit
        end

        -- 設定站立飛行速度
        hrp.Velocity = direction * FlySpeed
    end
end)



























-- ================= 建立滑動開關 =================
createOptionRow(contentFrame, y, "Fly to Player", function(row)
    local switchBg = Instance.new("Frame")
    switchBg.Size = UDim2.new(0,60,0.5,0)
    switchBg.Position = UDim2.new(1,-70,0.25,0)
    switchBg.BackgroundColor3 = Color3.fromRGB(100,100,100)
    switchBg.BorderSizePixel = 0
    switchBg.Parent = row
    Instance.new("UICorner", switchBg).CornerRadius = UDim.new(0,20)

    local knob = Instance.new("Frame")
    knob.Size = UDim2.new(0,28,1,0)
    knob.Position = UDim2.new(0,0,0,0)
    knob.BackgroundColor3 = Color3.fromRGB(255,255,255)
    knob.BorderSizePixel = 0
    knob.Parent = switchBg
    Instance.new("UICorner", knob).CornerRadius = UDim.new(0,20)

    -- 狀態同步函數
    local function setState(state)
        FlyEnabled = state
        NoclipEnabled = state
        if state then
            switchBg.BackgroundColor3 = Color3.fromRGB(0,200,0)
            knob:TweenPosition(UDim2.new(1,-28,0,0),"Out","Quad",0.15,true)
        else
            switchBg.BackgroundColor3 = Color3.fromRGB(100,100,100)
            knob:TweenPosition(UDim2.new(0,0,0,0),"Out","Quad",0.15,true)
        end
    end

    -- 初始化 UI 與狀態同步
    setState(FlyEnabled)

    -- 滑動開關點擊
    switchBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            setState(not FlyEnabled)
        end
    end)
end)

y = y + 60

-- 2️⃣ 玩家下拉選單
createOptionRow(contentFrame, y, "選擇玩家", function(row)
    local dropdown = Instance.new("TextButton")
    dropdown.Size = UDim2.new(0,160,0.6,0)
    dropdown.Position = UDim2.new(1,-170,0.2,0)
    dropdown.Text = "點選"
    dropdown.BackgroundColor3 = Color3.fromRGB(60,60,60)
    dropdown.TextColor3 = Color3.new(1,1,1)
    dropdown.Font = Enum.Font.SourceSans
    dropdown.TextSize = 16
    dropdown.Parent = row
    Instance.new("UICorner", dropdown)

    local list = Instance.new("Frame")
    list.Size = UDim2.new(0,160,0,0)
    list.Position = UDim2.new(1,-170,1,5)
    list.BackgroundColor3 = Color3.fromRGB(40,40,40)
    list.Visible = false
    list.ClipsDescendants = true
    list.Parent = row
    Instance.new("UICorner", list)

    local layout = Instance.new("UIListLayout", list)

    local function refreshPlayers()
        for _,c in ipairs(list:GetChildren()) do
            if c:IsA("TextButton") then c:Destroy() end
        end

        for _,plr in ipairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer then
                local btn = Instance.new("TextButton")
                btn.Size = UDim2.new(1,0,0,30)
                btn.Text = plr.Name
                btn.BackgroundColor3 = Color3.fromRGB(70,70,70)
                btn.TextColor3 = Color3.new(1,1,1)
                btn.Parent = list

                btn.MouseButton1Click:Connect(function()
                    TargetPlayer = plr
                    dropdown.Text = plr.Name
                    list.Visible = false
                    list:TweenSize(UDim2.new(0,160,0,0),"Out","Quad",0.15,true)
                end)
            end
        end

        list.Size = UDim2.new(0,160,0,layout.AbsoluteContentSize.Y)
    end

    dropdown.MouseButton1Click:Connect(function()
        list.Visible = not list.Visible
        refreshPlayers()
        list:TweenSize(
            list.Visible and UDim2.new(0,160,0,layout.AbsoluteContentSize.Y) or UDim2.new(0,160,0,0),
            "Out","Quad",0.15,true
        )
    end)

    Players.PlayerAdded:Connect(refreshPlayers)
    Players.PlayerRemoving:Connect(refreshPlayers)
end)
y = y + 60
