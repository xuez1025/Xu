-- ================= Services =================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- ================= State =================
local ESP_ENABLED = false
local ESP_COLOR = Color3.fromRGB(30,30,30) -- Highlight 顏色
local TEXT_COLOR = Color3.fromRGB(255,255,255) -- 文字白色

-- ================= ESP 建立/移除 =================
local function createESP(player)
    if player == LocalPlayer then return end -- 排除自己
    if not player.Character then return end
    if player.Character:FindFirstChild("ESP_Highlight") then return end

    -- Highlight
    local h = Instance.new("Highlight")
    h.Name = "ESP_Highlight"
    h.FillColor = ESP_COLOR
    h.OutlineColor = Color3.fromRGB(255,255,255)
    h.FillTransparency = 0.2
    h.OutlineTransparency = 0
    h.Adornee = player.Character
    h.Parent = player.Character

    local head = player.Character:FindFirstChild("Head")
    if not head then return end

    -- BillboardGui 文字
    local bill = Instance.new("BillboardGui")
    bill.Name = "ESP_Billboard"
    bill.Size = UDim2.fromOffset(180,60)
    bill.StudsOffset = Vector3.new(0, 3, 0)
    bill.AlwaysOnTop = true
    bill.Parent = head

    -- 文字
    local text = Instance.new("TextLabel", bill)
    text.Name = "Info"
    text.Size = UDim2.fromOffset(180,50)
    text.Position = UDim2.new(0,0,0,0)
    text.BackgroundTransparency = 1
    text.TextColor3 = TEXT_COLOR
    text.TextStrokeTransparency = 0
    text.Font = Enum.Font.SourceSansBold
    text.TextSize = 20
    text.TextWrapped = true
    text.TextYAlignment = Enum.TextYAlignment.Top
    text.Text = player.Name

    -- 血條背景
    local barBG = Instance.new("Frame", bill)
    barBG.Name = "HP_Background"
    barBG.Size = UDim2.new(0.8,0,0.08,0)
    barBG.Position = UDim2.new(0.1,0,0.7,0)
    barBG.BackgroundColor3 = Color3.fromRGB(50,50,50)
    barBG.BorderSizePixel = 0

    -- 血條前景
    local barFG = Instance.new("Frame", barBG)
    barFG.Name = "HP_Fill"
    barFG.Size = UDim2.new(1,0,1,0)
    barFG.Position = UDim2.new(0,0,0,0)
    barFG.BackgroundColor3 = Color3.fromRGB(0,255,0)
    barFG.BorderSizePixel = 0
end

local function removeESP(player)
    if player == LocalPlayer then return end -- 排除自己
    if not player.Character then return end
    local h = player.Character:FindFirstChild("ESP_Highlight")
    if h then h:Destroy() end
    local head = player.Character:FindFirstChild("Head")
    if head then
        local bill = head:FindFirstChild("ESP_Billboard")
        if bill then bill:Destroy() end
    end
end

-- ================= 更新 ESP 文字 + 血條 =================
local function updateESP()
    if not ESP_ENABLED or not LocalPlayer.Character then return end
    local myHRP = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not myHRP then return end

    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            local humanoid = p.Character:FindFirstChildOfClass("Humanoid")
            local hrp = p.Character:FindFirstChild("HumanoidRootPart")
            local head = p.Character:FindFirstChild("Head")
            if humanoid and hrp and head then
                local bill = head:FindFirstChild("ESP_Billboard")
                if bill then
                    local info = bill:FindFirstChild("Info")
                    local barFG = bill:FindFirstChild("HP_Background") and bill.HP_Background:FindFirstChild("HP_Fill")
                    if info then
                        local dist = math.floor((myHRP.Position - hrp.Position).Magnitude)
                        info.Text = string.format("%s [%dHP]\n距離: %dm", p.Name, math.floor(humanoid.Health), dist)
                    end
                    if barFG then
                        local healthRatio = math.clamp(humanoid.Health / humanoid.MaxHealth,0,1)
                        if healthRatio > 0.6 then
                            barFG.BackgroundColor3 = Color3.fromRGB(0,255,0)
                        elseif healthRatio > 0.3 then
                            barFG.BackgroundColor3 = Color3.fromRGB(255,255,0)
                        else
                            barFG.BackgroundColor3 = Color3.fromRGB(255,0,0)
                        end
                        barFG.Size = UDim2.new(healthRatio,0,1,0)
                    end
                end
            end
        end
    end
end

-- ================= UI =================
local gui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromOffset(240,80)
frame.Position = UDim2.fromScale(0.5,0.5)
frame.AnchorPoint = Vector2.new(0.5,0.5)
frame.BackgroundColor3 = Color3.fromRGB(30,30,30)

local function createButton(text,posY)
    local btn = Instance.new("TextButton", frame)
    btn.Size = UDim2.fromOffset(220,45)
    btn.Position = UDim2.fromOffset(10,posY)
    btn.Text = text
    btn.TextWrapped = true
    btn.TextColor3 = Color3.new(1,1,1)
    btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 16
    return btn
end

local espBtn = createButton("ESP : OFF",10)
espBtn.MouseButton1Click:Connect(function()
    ESP_ENABLED = not ESP_ENABLED
    espBtn.Text = "ESP : " .. (ESP_ENABLED and "ON" or "OFF")
    for _, p in ipairs(Players:GetPlayers()) do
        if ESP_ENABLED then createESP(p) else removeESP(p) end
    end
end)

-- ================= UI Drag =================
local dragging, dragInput, dragStart, startPos
frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

RunService.RenderStepped:Connect(function()
    if dragging and dragInput then
        local delta = dragInput.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end
    updateESP()
end)

-- ================= Player Events =================
local function setupPlayerESP(p)
    if p == LocalPlayer then return end -- 排除自己
    p.CharacterAdded:Connect(function()
        task.wait(0.2)
        if ESP_ENABLED then createESP(p) end
    end)
    if ESP_ENABLED and p.Character then
        createESP(p)
    end
end

for _, p in ipairs(Players:GetPlayers()) do
    if p ~= LocalPlayer then
        setupPlayerESP(p)
    end
end

Players.PlayerAdded:Connect(function(p)
    setupPlayerESP(p)
end)

Players.PlayerRemoving:Connect(function(p)
    removeESP(p)
end)
