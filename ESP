-- ================= Services =================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- ================= State =================
local ESP_ENABLED = false

-- ================= 判斷顏色函數 =================
local function getESPColor(player)
    local myTeam = LocalPlayer.Team
    local playerTeam = player.Team

    if myTeam and playerTeam then
        if myTeam == playerTeam then
            return Color3.fromRGB(0, 255, 0) -- 綠色：同陣營
        else
            return Color3.fromRGB(255, 0, 0) -- 紅色：敵人
        end
    end

    return Color3.fromRGB(255, 255, 255) -- 無陣營或無法判斷
end

-- ================= ESP 建立/移除 =================
local function createESP(player)
    if not player.Character then return end
    if player.Character:FindFirstChild("ESP_Highlight") then return end

    local color = getESPColor(player)

    -- Highlight（角色模型更顯眼）
    local h = Instance.new("Highlight")
    h.Name = "ESP_Highlight"
    h.FillColor = color
    h.OutlineColor = Color3.fromRGB(255,255,255)
    h.FillTransparency = 0.2 -- 更低透明度，模型顏色更明顯
    h.OutlineTransparency = 0 -- 輪廓完全可見
    h.Adornee = player.Character
    h.Parent = player.Character

    -- BillboardGui 文字
    local head = player.Character:FindFirstChild("Head")
    if not head then return end

    local bill = Instance.new("BillboardGui")
    bill.Name = "ESP_Billboard"
    bill.Size = UDim2.fromOffset(180,50)
    bill.StudsOffset = Vector3.new(0, 3, 0) -- 文字高於頭頂
    bill.AlwaysOnTop = true
    bill.Parent = head

    local text = Instance.new("TextLabel", bill)
    text.Size = UDim2.fromOffset(180,50)
    text.Position = UDim2.fromOffset(0,0)
    text.BackgroundTransparency = 1
    text.TextColor3 = color
    text.TextStrokeTransparency = 0
    text.TextTransparency = 0.2 -- 文字稍微透明
    text.Font = Enum.Font.SourceSansBold
    text.TextSize = 20
    text.Name = "Info"
end

local function removeESP(player)
    if not player.Character then return end
    local h = player.Character:FindFirstChild("ESP_Highlight")
    if h then h:Destroy() end
    local head = player.Character:FindFirstChild("Head")
    if head then
        local bill = head:FindFirstChild("ESP_Billboard")
        if bill then bill:Destroy() end
    end
end

local function refreshESP()
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            if ESP_ENABLED then
                createESP(p)
            else
                removeESP(p)
            end
        end
    end
end

-- ================= UI =================
local gui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromOffset(240,80)
frame.Position = UDim2.fromScale(0.5,0.5)
frame.AnchorPoint = Vector2.new(0.5,0.5)
frame.BackgroundColor3 = Color3.fromRGB(30,30,30)

local function createButton(text,posY)
    local btn = Instance.new("TextButton", frame)
    btn.Size = UDim2.fromOffset(220,45)
    btn.Position = UDim2.fromOffset(10,posY)
    btn.Text = text
    btn.TextWrapped = true
    btn.TextColor3 = Color3.new(1,1,1)
    btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 16
    return btn
end

local espBtn = createButton("ESP : OFF",10)

-- ================= UI Logic =================
espBtn.MouseButton1Click:Connect(function()
    ESP_ENABLED = not ESP_ENABLED
    espBtn.Text = "ESP : " .. (ESP_ENABLED and "ON" or "OFF")
    refreshESP()
end)

-- ================= UI Drag =================
local dragging, dragInput, dragStart, startPos
frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

-- ================= Update =================
RunService.RenderStepped:Connect(function()
    -- 拖動 UI
    if dragging and dragInput then
        local delta = dragInput.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end

    if ESP_ENABLED and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local myPos = LocalPlayer.Character.HumanoidRootPart.Position
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Head") then
                local bill = p.Character.Head:FindFirstChild("ESP_Billboard")
                local hrp = p.Character:FindFirstChild("HumanoidRootPart")
                if bill and hrp then
                    local dist = (myPos - hrp.Position).Magnitude

                    -- 更新文字與顏色
                    local info = bill:FindFirstChild("Info")
                    if info then
                        info.Text = p.Name .. " [" .. math.floor(dist) .. "m]"
                        info.TextColor3 = getESPColor(p)
                    end

                    -- 更新 Highlight 顏色
                    local highlight = p.Character:FindFirstChild("ESP_Highlight")
                    if highlight then
                        highlight.FillColor = getESPColor(p)
                    end
                end
            end
        end
    end
end)

-- ================= Player Events =================
local function setupPlayerESP(p)
    -- 玩家角色生成時
    p.CharacterAdded:Connect(function()
        task.wait(0.2)
        if ESP_ENABLED then createESP(p) end
    end)
    -- 如果角色已存在，立即新增 ESP
    if ESP_ENABLED and p.Character then
        createESP(p)
    end
end

-- 現有玩家
for _, p in ipairs(Players:GetPlayers()) do
    if p ~= LocalPlayer then
        setupPlayerESP(p)
    end
end

-- 新加入玩家
Players.PlayerAdded:Connect(function(p)
    setupPlayerESP(p)
end)

-- 玩家離開
Players.PlayerRemoving:Connect(function(p)
    removeESP(p)
end)
