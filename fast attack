-- 基本設定
_G.FastAttack = true
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Player = Players.LocalPlayer

local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")
local EnemiesFolder = workspace:WaitForChild("Enemies")
local CharactersFolder = workspace:WaitForChild("Characters")

local Settings = {
    AutoClick = true,
    Distance = 0,
    AttackInterval = 0.01,
    MaxTargets = 20
}

local function IsAlive(char)
    local hum = char:FindFirstChild("Humanoid")
    return hum and hum.Health > 0
end

-- GUI 建立
local PlayerGui = Player:WaitForChild("PlayerGui")
if PlayerGui:FindFirstChild("FastAttackGUI") then
    PlayerGui.FastAttackGUI:Destroy()
end

local gui = Instance.new("ScreenGui")
gui.Name = "FastAttackGUI"
gui.ResetOnSpawn = false
gui.Parent = PlayerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.fromOffset(420, 220)
frame.Position = UDim2.fromOffset(100, 100)
frame.BackgroundColor3 = Color3.fromRGB(40,40,40)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = gui

-- 標題
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -60, 0, 30)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Xu fast-attack"
title.TextColor3 = Color3.fromRGB(255,255,255)
title.TextScaled = true
title.Parent = frame

-- 關閉按鈕
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.fromOffset(30, 30)
closeBtn.Position = UDim2.new(1, -30, 0, 0)
closeBtn.BackgroundColor3 = Color3.fromRGB(200,50,50)
closeBtn.TextColor3 = Color3.fromRGB(255,255,255)
closeBtn.Text = "X"
closeBtn.TextScaled = true
closeBtn.Parent = frame
closeBtn.MouseButton1Click:Connect(function()
    gui:Destroy()
end)

-- 縮小按鈕
local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.fromOffset(30,30)
minimizeBtn.Position = UDim2.new(1, -60, 0, 0)
minimizeBtn.BackgroundColor3 = Color3.fromRGB(100,100,100)
minimizeBtn.TextColor3 = Color3.fromRGB(255,255,255)
minimizeBtn.Text = "-"
minimizeBtn.TextScaled = true
minimizeBtn.Parent = frame

local minimizedFrame = nil
local function minimize()
    frame.Visible = false
    minimizedFrame = Instance.new("TextButton")
    minimizedFrame.Size = UDim2.fromOffset(50,50)
    minimizedFrame.Position = frame.Position
    minimizedFrame.BackgroundColor3 = Color3.fromRGB(0,0,0)  -- 黑底
    minimizedFrame.BorderSizePixel = 0
    minimizedFrame.Text = "Xu"
    minimizedFrame.TextColor3 = Color3.fromRGB(255,255,255)   -- 白字
    minimizedFrame.TextScaled = true
    minimizedFrame.Parent = gui
    minimizedFrame.MouseButton1Click:Connect(function()
        frame.Visible = true
        minimizedFrame:Destroy()
        minimizedFrame = nil
    end)
end

minimizeBtn.MouseButton1Click:Connect(minimize)

-- 自動攻擊開關
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(1,-20,0,40)
toggleBtn.Position = UDim2.new(0,10,0,40)
toggleBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
toggleBtn.TextColor3 = Color3.fromRGB(255,255,255)
toggleBtn.TextScaled = true
toggleBtn.Text = "自動攻擊: 開"
toggleBtn.Parent = frame
toggleBtn.MouseButton1Click:Connect(function()
    Settings.AutoClick = not Settings.AutoClick
    toggleBtn.Text = "自動攻擊: "..(Settings.AutoClick and "開" or "關")
end)

-- 攻擊距離標籤
local label = Instance.new("TextLabel")
label.Size = UDim2.new(0,150,0,25)
label.Position = UDim2.new(0,10,0,90)
label.BackgroundTransparency = 1
label.TextColor3 = Color3.fromRGB(255,255,0)
label.TextScaled = true
label.Text = "攻擊距離: "..Settings.Distance.." 米"
label.TextXAlignment = Enum.TextXAlignment.Left
label.Parent = frame

-- 輸入框
local inputBox = Instance.new("TextBox")
inputBox.Size = UDim2.new(0,80,0,25)
inputBox.Position = UDim2.new(0,170,0,90)
inputBox.BackgroundColor3 = Color3.fromRGB(70,70,70)
inputBox.TextColor3 = Color3.fromRGB(255,255,255)
inputBox.TextScaled = true
inputBox.ClearTextOnFocus = false
inputBox.Text = tostring(Settings.Distance)
inputBox.Parent = frame

-- 最大值提示
local maxLabel = Instance.new("TextLabel")
maxLabel.Size = UDim2.new(0,100,0,25)
maxLabel.Position = UDim2.new(0,260,0,90)
maxLabel.BackgroundTransparency = 1
maxLabel.TextColor3 = Color3.fromRGB(200,200,200)
maxLabel.TextScaled = true
maxLabel.Text = "(max:1000 米)"
maxLabel.TextXAlignment = Enum.TextXAlignment.Left
maxLabel.Parent = frame

-- 滑桿
local slider = Instance.new("Frame")
slider.Size = UDim2.new(1,-40,0,30)
slider.Position = UDim2.new(0,10,0,130)
slider.BackgroundColor3 = Color3.fromRGB(100,100,100)
slider.BorderSizePixel = 0
slider.Parent = frame

local fill = Instance.new("Frame")
fill.Size = UDim2.new(0,0,1,0)
fill.BackgroundColor3 = Color3.fromRGB(255,200,0)
fill.BorderSizePixel = 0
fill.Parent = slider

local dragging = false
local MAX_DISTANCE = 1000

slider.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        frame.Draggable = false
    end
end)
slider.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
        frame.Draggable = true
    end
end)
slider.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local mouseX = input.Position.X - slider.AbsolutePosition.X
        mouseX = math.clamp(mouseX,0,slider.AbsoluteSize.X)
        local distance = (mouseX/slider.AbsoluteSize.X) * MAX_DISTANCE
        Settings.Distance = distance
        label.Text = "攻擊距離: "..math.floor(distance).." 米"
        inputBox.Text = tostring(math.floor(distance))
        fill.Size = UDim2.new(mouseX/slider.AbsoluteSize.X,0,1,0)
    end
end)

inputBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        local val = tonumber(inputBox.Text)
        if val then
            local distance = math.clamp(val,0,MAX_DISTANCE)
            Settings.Distance = distance
            inputBox.Text = tostring(math.floor(distance))
            label.Text = "攻擊距離: "..math.floor(distance).." 米"
            fill.Size = UDim2.new(distance/MAX_DISTANCE,0,1,0)
        else
            inputBox.Text = tostring(math.floor(Settings.Distance))
        end
    end
end)

-- 核心攻擊
task.spawn(function()
    while _G.FastAttack do
        if Settings.AutoClick then
            local root = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
            if root then
                local targets = {}
                for _, folder in ipairs({EnemiesFolder, CharactersFolder}) do
                    for _, obj in ipairs(folder:GetChildren()) do
                        if obj ~= Player.Character then
                            local head = obj:FindFirstChild("Head")
                            if head and IsAlive(obj) then
                                local dist = (head.Position - root.Position).Magnitude
                                if dist <= Settings.Distance then
                                    table.insert(targets,{obj,head})
                                    if #targets >= Settings.MaxTargets then break end
                                end
                            end
                        end
                    end
                    if #targets >= Settings.MaxTargets then break end
                end

                local aliveTargets = {}
                for _, t in ipairs(targets) do
                    if IsAlive(t[1]) then
                        table.insert(aliveTargets, t)
                    end
                end

                if #aliveTargets > 0 then
                    RegisterAttack:FireServer(0)
                    RegisterHit:FireServer(aliveTargets[1][2], aliveTargets)
                end
            end
        end
        task.wait(Settings.AttackInterval)
    end
end)
